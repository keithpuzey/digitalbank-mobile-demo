pipeline {
    agent any

    environment {
        BLAZEMETER_API_KEY = credentials('BlazeMeter-API-Key')
        ANTHROPIC_API_KEY = credentials('anthropic-api-key')
        MCP_PORT = "3333"
        MCP_HOST = "127.0.0.1"
        MCP_URL = "http://${MCP_HOST}:${MCP_PORT}"
        CLAUDE_CONFIG_DIR = "${WORKSPACE}/.claude"
    }

    stages {

stage('Install dependencies') {
    steps {
        sh '''
            set -e

            # Install uv if missing
            if ! command -v uv >/dev/null 2>&1; then
                echo "Installing uv..."
                curl -LsSf https://astral.sh/uv/install.sh | sh
                export PATH="$HOME/.cargo/bin:$PATH"
            fi

            # Ensure Node.js and npm exist
            if ! command -v npx >/dev/null 2>&1; then
                echo "Installing Node.js and npm..."
                # Use NodeSource repo for CentOS
                curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
                sudo dnf install -y nodejs
            fi

            # Install Claude CLI if missing
            if ! command -v claude >/dev/null 2>&1; then
                echo "Installing Claude CLI..."
                curl -fsSL https://claude.ai/install.sh | sh
                export PATH="$HOME/.local/bin:$PATH"
            fi

            echo "uv: $(uv --version || echo 'not available')"
            echo "npx: $(npx --version || echo 'not available')"
            echo "claude: $(claude --version || echo 'not available')"
        '''
    }
}


        stage('Configure Claude with MCP') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.local/bin:$PATH"
                    
                    cat > "${CLAUDE_CONFIG_DIR}/settings.local.json" << EOF

{
  "permissions": {
    "allow": [
      "mcp__BlazeMeter__blazemeter_workspaces",
      "mcp__BlazeMeter__blazemeter_account"
    ]
  }
}
EOF


                    mkdir -p "${CLAUDE_CONFIG_DIR}"
                    cat > "${CLAUDE_CONFIG_DIR}/auth.json" << EOF

{
  "current": "default",
  "profiles": {
    "default": {
      "apiKey": "${ANTHROPIC_API_KEY}",
      "authType": "apiKey"
    }
  }
}
EOF


                    # Create MCP configuration for Claude using native binary
                    cat > "${CLAUDE_CONFIG_DIR}/mcp.json" << EOF
{
  "mcpServers": {
    "BlazeMeter": {
      "command": "/src/mcp/bzm-mcp-linux-amd64",
      "args": [
        "--mcp"
      ],
      "env": {
        "BLAZEMETER_API_KEY": "/src/mcp/api-key.json"
      }
    }
  }
}
EOF
                    
                    echo "MCP configuration created at ${CLAUDE_CONFIG_DIR}/mcp.json"
                    cat "${CLAUDE_CONFIG_DIR}/mcp.json"
                '''
            }
        }


        stage('Run Performance Test via Claude') {
            steps {
                script {
                    // Create a prompt file for Claude
                    def claudePrompt = """
Please use the BlazeMeter MCP server to run a performance test with the following details:
- Test ID: 123456 (replace with your actual test ID)
- Test Name: Jenkins-Triggered Performance Test

After running the test, please provide:
1. Test execution status
2. Key performance metrics
3. Any issues or anomalies detected
4. Recommendations for optimization

Format the results in a clear, structured way.
"""
                    writeFile file: "${WORKSPACE}/mcp_run/claude_prompt.txt", text: claudePrompt
                    
                    sh '''
                        set -e
                        export PATH="$HOME/.local/bin:$PATH"
                        export CLAUDE_CONFIG_DIR="${CLAUDE_CONFIG_DIR}"
                        
                        cd "${WORKSPACE}/mcp_run"
                        
                        echo "Running Claude with BlazeMeter MCP..."
                        claude chat < claude_prompt.txt > claude_output.txt
                        
                        echo "=== Claude Output ==="
                        cat claude_output.txt
                        echo "===================="
                    '''
                }
            }
        }

        stage('Analyze Results with Claude') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.local/bin:$PATH"
                    export CLAUDE_CONFIG_DIR="${CLAUDE_CONFIG_DIR}"
                    
                    cd "${WORKSPACE}/mcp_run"
                    
                    # Ask Claude to analyze the test results
                    echo "Based on the performance test results, please provide:
1. A summary of test execution
2. Performance bottlenecks identified
3. Comparison with baseline metrics (if available)
4. Actionable recommendations for the development team
5. Risk assessment (High/Medium/Low) for production deployment

Format this as a brief executive summary suitable for management." | \
                    claude chat > analysis_report.txt
                    
                    echo "=== Analysis Report ==="
                    cat analysis_report.txt
                    echo "======================="
                    
                    # Archive the reports
                    cp claude_output.txt analysis_report.txt "${WORKSPACE}/"
                '''
            }
        }

        stage('Alternative: Use Claude Task Command') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.local/bin:$PATH"
                    export CLAUDE_CONFIG_DIR="${CLAUDE_CONFIG_DIR}"
                    
                    cd "${WORKSPACE}/mcp_run"
                    
                    # Using claude task for more focused execution
                    echo "Running focused task with Claude..."
                    claude task "Use the BlazeMeter MCP to run test ID 123456, analyze the results, and create a summary report with key metrics and recommendations" \
                        > task_output.txt
                    
                    echo "=== Task Output ==="
                    cat task_output.txt
                    echo "==================="
                '''
            }
        }

        stage('Cleanup') {
            steps {
                sh '''
                    set -e
                    WORKDIR="${WORKSPACE}/mcp_run"
                    
                    if [ -f "$WORKDIR/bzm-mcp.pid" ]; then
                        PID=$(cat "$WORKDIR/bzm-mcp.pid")
                        echo "Stopping bzm-mcp PID ${PID}..."
                        kill ${PID} || kill -9 ${PID} || true 
                        rm -f "$WORKDIR/bzm-mcp.pid"
                    fi
                    
                    echo "Cleanup complete"
                '''
            }
        }
    }

    post {
        always {
            // Archive the Claude outputs and reports
            archiveArtifacts artifacts: '**/claude_output.txt,**/analysis_report.txt,**/task_output.txt,**/bzm-mcp.log', allowEmptyArchive: true
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check the logs for details.'
        }
    }
}