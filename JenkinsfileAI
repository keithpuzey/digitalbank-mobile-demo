pipeline {
    agent any

    environment {
        BLAZEMETER_API_KEY = credentials('BlazeMeter-API-Key')
        ANTHROPIC_API_KEY = credentials('anthropic-api-key')
        MCP_PORT = "3333"
        MCP_HOST = "127.0.0.1"
        MCP_URL = "http://${MCP_HOST}:${MCP_PORT}"
        CLAUDE_CONFIG_DIR = "${WORKSPACE}/.claude"
    }

    stages {

stage('Install dependencies') {
    steps {
        sh '''
            set -e

            # Install uv if missing
            if ! command -v uv >/dev/null 2>&1; then
                echo "Installing uv..."
                curl -LsSf https://astral.sh/uv/install.sh | sh
                export PATH="$HOME/.cargo/bin:$PATH"
            fi

            # Ensure Node.js and npm exist
            if ! command -v npx >/dev/null 2>&1; then
                echo "Installing Node.js and npm..."
                # Use NodeSource repo for CentOS
                curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
                dnf install -y nodejs
            fi

            # Install Claude CLI if missing
            if ! command -v claude >/dev/null 2>&1; then
                echo "Installing Claude CLI..."
                curl -fsSL https://cli.claude.ai/install.sh | sh
                export PATH="$HOME/.local/bin:$PATH"
            fi

            echo "uv: $(uv --version || echo 'not available')"
            echo "npx: $(npx --version || echo 'not available')"
            echo "claude: $(claude --version || echo 'not available')"
        '''
    }
}

        stage('Start BlazeMeter MCP Server') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.cargo/bin:$PATH"
                    
                    WORKDIR="${WORKSPACE}/mcp_run"
                    mkdir -p "$WORKDIR"
                    
                    # Set up BlazeMeter API key
                    if [ -n "${BLAZEMETER_API_KEY}" ]; then
                        echo "$BLAZEMETER_API_KEY" > "$WORKDIR/api-key.json"
                        export BLAZEMETER_API_KEY="$WORKDIR/api-key.json"
                    fi

                    cd "$WORKDIR"

                    echo "Launching bzm-mcp server..."
                    uvx --from git+https://github.com/BlazeMeter/bzm-mcp.git@v1.0.1 -q bzm-mcp --mcp \
                        > bzm-mcp.log 2>&1 &

                    MCP_PID=$!
                    echo $MCP_PID > bzm-mcp.pid
                    echo "bzm-mcp PID: $MCP_PID"

                    # Wait for server to be ready
                    echo "Waiting for MCP server at ${MCP_URL}..."
                    for i in $(seq 1 30); do
                        curl -sSf "${MCP_URL}/health" >/dev/null 2>&1 && { echo "MCP healthy"; break; }
                        nc -z ${MCP_HOST} ${MCP_PORT} >/dev/null 2>&1 && { echo "TCP ${MCP_PORT} open"; break; }
                        echo -n "."
                        sleep 1
                    done

                    # Verify server is running
                    curl -sSf "${MCP_URL}/health" >/dev/null 2>&1 || { 
                        echo "ERROR: MCP server failed to start. Logs:"
                        cat bzm-mcp.log
                        exit 1
                    }

                    echo "--- Server Log Snippet ---"
                    tail -n 20 bzm-mcp.log
                    echo "--------------------------"
                '''
            }
        }

        stage('Configure Claude with MCP') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.local/bin:$PATH"
                    
                    mkdir -p "${CLAUDE_CONFIG_DIR}"
                    
                    # Create MCP configuration for Claude
                    cat > "${CLAUDE_CONFIG_DIR}/mcp.json" << 'EOF'
{
  "mcpServers": {
    "blazemeter": {
      "command": "uvx",
      "args": [
        "--from",
        "git+https://github.com/BlazeMeter/bzm-mcp.git@v1.0.1",
        "-q",
        "bzm-mcp",
        "--mcp"
      ],
      "env": {
        "BLAZEMETER_API_KEY": "${BLAZEMETER_API_KEY}"
      }
    }
  }
}
EOF
                    
                    echo "MCP configuration created at ${CLAUDE_CONFIG_DIR}/mcp.json"
                    cat "${CLAUDE_CONFIG_DIR}/mcp.json"
                '''
            }
        }

        stage('Authenticate Claude') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.local/bin:$PATH"
                    export CLAUDE_CONFIG_DIR="${CLAUDE_CONFIG_DIR}"
                    
                    echo "Authenticating Claude CLI..."
                    claude auth login --api-key "${ANTHROPIC_API_KEY}"
                    
                    echo "Claude authentication successful"
                '''
            }
        }

        stage('Run Performance Test via Claude') {
            steps {
                script {
                    // Create a prompt file for Claude
                    def claudePrompt = """
Please use the BlazeMeter MCP server to run a performance test with the following details:
- Test ID: 123456 (replace with your actual test ID)
- Test Name: Jenkins-Triggered Performance Test

After running the test, please provide:
1. Test execution status
2. Key performance metrics
3. Any issues or anomalies detected
4. Recommendations for optimization

Format the results in a clear, structured way.
"""
                    writeFile file: "${WORKSPACE}/mcp_run/claude_prompt.txt", text: claudePrompt
                    
                    sh '''
                        set -e
                        export PATH="$HOME/.local/bin:$PATH"
                        export CLAUDE_CONFIG_DIR="${CLAUDE_CONFIG_DIR}"
                        
                        cd "${WORKSPACE}/mcp_run"
                        
                        echo "Running Claude with BlazeMeter MCP..."
                        claude chat < claude_prompt.txt > claude_output.txt
                        
                        echo "=== Claude Output ==="
                        cat claude_output.txt
                        echo "===================="
                    '''
                }
            }
        }

        stage('Analyze Results with Claude') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.local/bin:$PATH"
                    export CLAUDE_CONFIG_DIR="${CLAUDE_CONFIG_DIR}"
                    
                    cd "${WORKSPACE}/mcp_run"
                    
                    # Ask Claude to analyze the test results
                    echo "Based on the performance test results, please provide:
1. A summary of test execution
2. Performance bottlenecks identified
3. Comparison with baseline metrics (if available)
4. Actionable recommendations for the development team
5. Risk assessment (High/Medium/Low) for production deployment

Format this as a brief executive summary suitable for management." | \
                    claude chat > analysis_report.txt
                    
                    echo "=== Analysis Report ==="
                    cat analysis_report.txt
                    echo "======================="
                    
                    # Archive the reports
                    cp claude_output.txt analysis_report.txt "${WORKSPACE}/"
                '''
            }
        }

        stage('Alternative: Use Claude Task Command') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.local/bin:$PATH"
                    export CLAUDE_CONFIG_DIR="${CLAUDE_CONFIG_DIR}"
                    
                    cd "${WORKSPACE}/mcp_run"
                    
                    # Using claude task for more focused execution
                    echo "Running focused task with Claude..."
                    claude task "Use the BlazeMeter MCP to run test ID 123456, analyze the results, and create a summary report with key metrics and recommendations" \
                        > task_output.txt
                    
                    echo "=== Task Output ==="
                    cat task_output.txt
                    echo "==================="
                '''
            }
        }

        stage('Cleanup') {
            steps {
                sh '''
                    set -e
                    WORKDIR="${WORKSPACE}/mcp_run"
                    
                    if [ -f "$WORKDIR/bzm-mcp.pid" ]; then
                        PID=$(cat "$WORKDIR/bzm-mcp.pid")
                        echo "Stopping bzm-mcp PID ${PID}..."
                        kill ${PID} || kill -9 ${PID} || true 
                        rm -f "$WORKDIR/bzm-mcp.pid"
                    fi
                    
                    echo "Cleanup complete"
                '''
            }
        }
    }

    post {
        always {
            // Archive the Claude outputs and reports
            archiveArtifacts artifacts: '**/claude_output.txt,**/analysis_report.txt,**/task_output.txt,**/bzm-mcp.log', allowEmptyArchive: true
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check the logs for details.'
        }
    }
}