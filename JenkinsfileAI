pipeline {
    agent any

    environment {
        BLAZEMETER_API_KEY = credentials('BlazeMeter-API-Key') // Jenkins secret text or file
        MCP_PORT = "3333"
        MCP_HOST = "127.0.0.1"
        MCP_URL  = "http://${MCP_HOST}:${MCP_PORT}"
        PATH = "${HOME}/.cargo/bin:/usr/local/bin:/usr/bin:/bin"
    }

    stages {

        stage('Install uv & Python dependencies') {
            steps {
                sh '''
                    set -e

                    # Install uv if missing
                    if ! command -v uv >/dev/null 2>&1; then
                        echo "Installing uv..."
                        curl -LsSf https://astral.sh/uv/install.sh | sh
                    fi

                    export PATH="$HOME/.cargo/bin:$PATH"

                    # Verify Python version (Python 3.11+ required)
                    if ! python3 --version | grep -q "Python 3.11"; then
                        echo "Python 3.11+ required. Please install it on the agent."
                        exit 1
                    fi

                    # Install MCP Python client
                    pip3 install --user bzm-mcp-client
                '''
            }
        }

        stage('Start BlazeMeter MCP Server (background)') {
            steps {
                sh '''
                    set -e
                    WORKDIR="${WORKSPACE}/mcp_run"
                    mkdir -p "$WORKDIR"

                    # Write API key to file if secret text
                    echo "$BLAZEMETER_API_KEY" > "$WORKDIR/api-key.json"

                    cd "$WORKDIR"

                    echo "Launching bzm-mcp server via uvx..."
                    uvx --from git+https://github.com/Blazemeter/bzm-mcp.git@v1.0.1 -q bzm-mcp --mcp \
                        > bzm-mcp.log 2>&1 &

                    MCP_PID=$!
                    echo $MCP_PID > bzm-mcp.pid
                    echo "bzm-mcp PID: $MCP_PID"

                    # Wait for server to be ready (TCP probe)
                    echo "Waiting for MCP server to be ready on port ${MCP_PORT}..."
                    for i in $(seq 1 30); do
                        nc -z ${MCP_HOST} ${MCP_PORT} && break
                        echo -n "."
                        sleep 1
                    done
                    echo "MCP server is ready."
                '''
            }
        }

        stage('Send Prompt via Python MCP Client') {
            steps {
                script {
                    def mcpResponse = sh(
                        script: '''
                            set -e
                            WORKDIR="${WORKSPACE}/mcp_run"
                            cd "$WORKDIR"

                            python3 - <<'EOF'
import json
from bzm_mcp_client import MCPClient

server_url = "http://127.0.0.1:3333"
api_key_file = "api-key.json"

client = MCPClient(server_url=server_url, api_key_file=api_key_file)
response = client.chat("Summarize the last BlazeMeter test results")
print(json.dumps(response, indent=2))
EOF
                        ''',
                        returnStdout: true
                    ).trim()

                    echo "MCP Response:\n${mcpResponse}"
                }
            }
        }

        stage('Cleanup MCP server') {
            steps {
                sh '''
                    WORKDIR="${WORKSPACE}/mcp_run"
                    if [ -f "$WORKDIR/bzm-mcp.pid" ]; then
                        PID=$(cat "$WORKDIR/bzm-mcp.pid")
                        echo "Stopping bzm-mcp PID ${PID}..."
                        kill ${PID} || true
                        rm -f "$WORKDIR/bzm-mcp.pid"
                    fi
                '''
            }
        }
    }
}