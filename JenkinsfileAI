pipeline {
  agent any

  environment {
    BLAZEMETER_API_KEY = credentials('BlazeMeter-API-Key') // file credential or secret text
    MCP_PORT = "3333"
    MCP_HOST = "127.0.0.1"
    MCP_URL  = "http://${MCP_HOST}:${MCP_PORT}"
  }

  stages {

    stage('Install uv & npm (if needed)') {
      steps {
        sh '''
          set -e
          # install uv if missing
          if ! command -v uv >/dev/null 2>&1; then
            echo "Installing uv..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.cargo/bin:$PATH"
          fi

          # ensure npm (npx) exists for the client
          if ! command -v npx >/dev/null 2>&1; then
            echo "Node / npm not found â€” installing minimal node (this step may vary by distro)"
            # Debian/Ubuntu example - change for RHEL if needed
            sudo apt-get update -y
            sudo apt-get install -y nodejs npm || true
          fi

          echo "uv: $(uv --version || echo 'uv not available')"
          echo "npx: $(npx --version || echo 'npx not available')"
        '''
      }
    }

    stage('Start BlazeMeter MCP Server (background)') {
      steps {
        sh '''
          set -e

          export PATH="$HOME/.cargo/bin:$PATH"
          # create a small working dir for API key
          WORKDIR="${WORKSPACE}/mcp_run"
          mkdir -p "$WORKDIR"
          # If BLAZEMETER_API_KEY is a file credential, ensure it's available here.
          # Jenkins credentials binding may either create a file or expose as text. Adjust as needed.
          # For example if it's secret text with JSON content, write it to file:
          if [ -n "${BLAZEMETER_API_KEY}" ]; then
            echo "$BLAZEMETER_API_KEY" > "$WORKDIR/api-key.json"
            export BLAZEMETER_API_KEY="$WORKDIR/api-key.json"
          fi

          cd "$WORKDIR"

          echo "Launching bzm-mcp server via uvx..."
          # Start server in background and redirect logs
          uvx --from git+https://github.com/BlazeMeter/bzm-mcp.git@v1.0.1 -q bzm-mcp --mcp \
            > bzm-mcp.log 2>&1 &

          MCP_PID=$!
          echo $MCP_PID > bzm-mcp.pid
          echo "bzm-mcp PID: $MCP_PID"

          # Wait for server to be ready (try the health endpoint or port)
          echo "Waiting for MCP server to respond at ${MCP_URL}..."
          for i in $(seq 1 30); do
            # try a common health endpoint; if not available, test TCP listen on port
            curl -sSf "${MCP_URL}/health" >/dev/null 2>&1 && { echo "MCP healthy"; break; }
            nc -z ${MCP_HOST} ${MCP_PORT} >/dev/null 2>&1 && { echo "TCP ${MCP_PORT} open"; break; }
            echo -n "."
            sleep 1
          done

          # show a little of the server log for debugging
          tail -n +1 bzm-mcp.log | sed -n '1,200p'
        '''
      }
    }

stage('Call MCP via Python client') {
  steps {
    sh '''
      python3 -m venv .venv
      source .venv/bin/activate
      pip install mcp2py

      # Write API key
      echo "$BLAZEMETER_API_KEY" > api-key.json

      # Run the client
      python3 mcp_client.py
    '''
  }
}

    stage('Cleanup MCP server') {
      steps {
        sh '''
          set -e
          WORKDIR="${WORKSPACE}/mcp_run"
          if [ -f "$WORKDIR/bzm-mcp.pid" ]; then
            PID=$(cat "$WORKDIR/bzm-mcp.pid")
            echo "Stopping bzm-mcp PID ${PID}..."
            kill ${PID} || true
            rm -f "$WORKDIR/bzm-mcp.pid"
          fi
        '''
      }
    }
  }
}