pipeline {
    agent any

    environment {
        // --- Environment Variables for MCP and API Keys ---
        BLAZEMETER_API_KEY = credentials('BlazeMeter-API-Key')
        CURSOR_API_KEY = credentials('cursor-api-key') // Kept the existing Cursor API Key variable

        // These MCP settings are less critical for Cursor CLI as it uses config files, but can remain if needed.
        MCP_PORT = "3333"
        MCP_HOST = "127.0.0.1"
        MCP_URL = "http://${MCP_HOST}:${MCP_PORT}"

        // CHANGED: Use a directory for Cursor's configuration files
        CURSOR_CONFIG_DIR = "${WORKSPACE}/.cursor" 
    }

    stages {

        stage('Install dependencies') {
            steps {
                sh '''
                    set -e

                    # Install uv if missing (uv installation logic remains)
                    if ! command -v uv >/dev/null 2>&1; then
                        echo "Installing uv..."
                        curl -LsSf https://astral.sh/uv/install.sh | sh
                        export PATH="$HOME/.cargo/bin:$PATH"
                    fi

                    # Ensure Node.js and npm exist (Node.js installation logic remains)
                    if ! command -v npx >/dev/null 2>&1; then
                        echo "Installing Node.js and npm..."
                        # Use NodeSource repo for CentOS
                        curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
                        sudo dnf install -y nodejs
                    fi
                    
                    # Install the Cursor Agent CLI (if not already installed/available)
                    if ! command -v cursor-agent >/dev/null 2>&1; then
                        echo "Installing Cursor Agent CLI..."
                        curl -LsSf https://astral.sh/uv/install.sh | sh
                        export PATH="$HOME/.cargo/bin:$PATH" # Only updates PATH inside this 'if'
                    fi


                '''
            }
        }

        stage('Configure Cursor with MCP') {
            steps {
                sh '''
                    set -e
                    export PATH="$HOME/.local/bin:$PATH"

                    # 1. Create the Cursor config directory
                    mkdir -p "${CURSOR_CONFIG_DIR}"

                    # 2. Configure MCP for Cursor by creating the project-level .cursor/mcp.json
                    # The Cursor CLI looks for mcp.json in the current working directory's .cursor/
                    cat > "${CURSOR_CONFIG_DIR}/mcp.json" << EOF
{
  "mcpServers": {
    "BlazeMeter": {
      "command": "/src/mcp/bzm-mcp-linux-amd64",
      "args": [
        "--mcp"
      ],
      "env": {
        "BLAZEMETER_API_KEY": "/src/mcp/api-key.json"
      }
    }
  }
}
EOF
                    
                    # 3. (Optional) Create a simple settings file if needed for permissions, though 
                    #    MCP configuration often handles this implicitly in Cursor CLI
                    cat > "${CURSOR_CONFIG_DIR}/settings.local.json" << EOF
{
  "permissions": {
    "allow": [
      "mcp__BlazeMeter__blazemeter_workspaces",
      "mcp__BlazeMeter__blazemeter_account"
    ]
  }
}
EOF

                    echo "MCP configuration created at ${CURSOR_CONFIG_DIR}/mcp.json"
                    cat "${CURSOR_CONFIG_DIR}/mcp.json"
                '''
            }
        }

        stage('Run Performance Test via Cursor Agent') {
            steps {
                script {
                    // Create a prompt file for the Cursor Agent
                    def cursorPrompt = """
Please use the BlazeMeter MCP server to run a performance test with the following details, do not create a script:
- Test ID: 13960763
- Workspace ID : 2014117
- Test Name: Jenkins-Triggered Performance Test

After running the test, please provide:
1. Test execution status
2. Key performance metrics
3. Any issues or anomalies detected
4. Recommendations for optimization

Format the results in a clear, structured way.
"""
                    writeFile file: "${WORKSPACE}/cursor_prompt.txt", text: cursorPrompt
                    
                    sh '''
                        set -e
                        export PATH="$HOME/.local/bin:$PATH"
                        # Export the API key for authentication
                        export CURSOR_API_KEY="${CURSOR_API_KEY}" 
                        
                        # Set WORKSPACE as the current directory so that the agent finds .cursor/mcp.json
                        cd "${WORKSPACE}" 
                        
                        echo "Running Cursor Agent with BlazeMeter MCP..."
                        
                        # CHANGED: Use 'cursor-agent' command with the prompt file
                        # Use '--prompt' or read from stdin. Reading from stdin is cleaner here.
                        cat "${WORKSPACE}/cursor_prompt.txt" | cursor-agent --api-key ${CURSOR_API_KEY} --print  > "${WORKSPACE}/cursor_output.txt"
                        
                        echo "=== Cursor Agent Output ==="
                        cat ${WORKSPACE}/cursor_output.txt
                        echo "========================="
                    '''
                }
            }
        }


    }

    post {
        always {
            // CHANGED: Updated artifact names to match 'cursor_output.txt'
            archiveArtifacts artifacts: '**/cursor_output.txt,**/analysis_report.txt,**/bzm-mcp.log', allowEmptyArchive: true
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check the logs for details.'
        }
    }
}